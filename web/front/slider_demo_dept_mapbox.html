
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Plotly 3.3 — Choropleth départements FR avec slider (sans frames)</title>
  <!-- Plotly.js v3.3 -->
  <script src="https://cdn.plot.ly/plotly-3.3.0.min.js"></script>
  <!-- d3 pour charger le GeoJSON -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; padding: 20px; }
  </style>
</head>
<body>
  <div id="chart" style="width: 100%; height: 650px; background: transparent;"></div>

  <script>
    // --- Paramètres ---
    const T = 20;               // nombre d'étapes du slider
    const zmin = 0, zmax = 100; // plage des valeurs

    // Source GeoJSON des départements (Gregoire David)
    const GEOJSON_URL = "https://raw.githubusercontent.com/gregoiredavid/france-geojson/master/departements.geojson";

    // Génère un tableau de valeurs aléatoires (1 décimale) de même longueur que 'codes'
    const randomValues = (codes) =>
      codes.map(() => parseFloat((Math.random() * (zmax - zmin) + zmin).toFixed(1)));

    // Charge le GeoJSON, prépare les données et construit le graphique
    d3.json(GEOJSON_URL).then(geojson => {
      const features = geojson.features || [];
      const codes = features.map(f => f.properties.code);   // ex: "01", "13", "75"
      const names = features.map(f => f.properties.nom);    // ex: "Ain", "Bouches-du-Rhône", "Paris"

      // Pré-calcul des T étapes de valeurs aléatoires
      const Z_STEPS = Array.from({ length: T }, () => randomValues(codes));

      // --- Trace initial (t = 0) ---
      const data = [{
        type: "choroplethmapbox",
        geojson: geojson,
        featureidkey: "properties.code",  // On aligne 'locations' avec 'properties.code'
        locations: codes,                 // Liste des codes de départements
        z: Z_STEPS[0],                    // Valeurs au step 0
        text: names,                      // Nom des départements pour le hover
        colorscale: "YlOrRd",
        zmin, zmax,
        marker: {
          opacity: 0.9,
          line: { width: 0.4, color: "#666" }
        },
        hovertemplate: "%{text}<br>Valeur: %{z:.1f}<extra></extra>"
      }];

      // --- Steps du slider (sans frames) ---
      const steps = Z_STEPS.map((zVals, idx) => ({
        label: String(idx),
        method: "update",
        args: [
          // 1) Mise à jour du 'z' du trace 0
          { z: [zVals] },
          // 2) Mise à jour du titre
          { title: `Choropleth — Départements FR — valeur aléatoire (t=${idx})` }
        ]
      }));

      // --- Layout : fond neutre et zoom France ---
      const layout = {
        title: { text: "Choropleth — Départements FR — valeur aléatoire (t=0)" },
        margin: { t: 60, r: 20, b: 20, l: 20 },
        mapbox: {
          style: "white-bg",           // ✅ fond blanc, aucune tuile de carte
          center: { lon: 2.5, lat: 46.5 },
          zoom: 4.3                     // zoom couvrant toute la France métropolitaine
        },
        paper_bgcolor: "rgba(0,0,0,0)",
        plot_bgcolor: "rgba(0,0,0,0)",
        sliders: [{
          active: 0,
          transition: { duration: 0 },
          currentvalue: {
            prefix: "Étape: ",
            xanchor: "right",
            font: { size: 14 }
          },
          steps
        }]
      };

      Plotly.newPlot("chart", data, layout);
    })
    .catch(err => {
      console.error("Erreur lors du chargement du GeoJSON :", err);
      const msg = document.createElement("pre");
      msg.textContent = "Impossible de charger le GeoJSON des départements.\n" +
                        "Vérifiez la connectivité et l'URL.";
      document.body.appendChild(msg);
    });
  </script>
</body>
</html>
